<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SYS.CORE // SETTINGS</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --panel: #111; --line: #333; --active: #00f0ff; --alert: #ff2a6d; --text: #ddd; --dim: #666; }
        * { box-sizing: border-box; outline: none; }
        
        body { 
            background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', monospace; 
            margin: 0; padding-bottom: 80px; min-height: 100vh;
            display: flex; flex-direction: column;
        }

        /* --- Header (Standardized) --- */
        header { 
            height: 60px; border-bottom: 1px solid var(--line); background: rgba(5,5,5,0.95); 
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px; 
            position: sticky; top: 0; z-index: 100; backdrop-filter: blur(5px);
        }
        h1 { font-size: 16px; margin: 0; color: var(--text); letter-spacing: 2px; }
        h1 span { color: var(--alert); }
        .back-link { color: var(--dim); text-decoration: none; font-size: 12px; transition: 0.3s; }
        .back-link:hover { color: #fff; }

        /* --- Main Layout --- */
        .container { max-width: 700px; margin: 30px auto; padding: 0 20px; }
        
        .card { 
            background: var(--panel); border: 1px solid var(--line); 
            padding: 25px; margin-bottom: 20px; 
        }
        .card-title { 
            font-size: 12px; color: var(--active); margin-bottom: 20px; 
            padding-bottom: 10px; border-bottom: 1px solid #222; 
            text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between;
        }

        /* --- Input Elements --- */
        .input-group { margin-bottom: 20px; }
        label { display: block; font-size: 10px; color: var(--dim); margin-bottom: 8px; }
        
        input, textarea { 
            width: 100%; background: #000; border: 1px solid var(--line); 
            color: #fff; padding: 12px; font-family: inherit; font-size: 14px; 
            transition: 0.3s;
        }
        input:focus, textarea:focus { border-color: var(--active); }
        textarea { height: 100px; resize: vertical; }

        /* Grid for compact inputs */
        .grid-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .grid-half { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        /* --- Maintenance Toggle (Custom) --- */
        .maint-switch {
            display: flex; align-items: center; justify-content: space-between;
            background: #000; border: 1px solid var(--line); padding: 15px;
            cursor: pointer; transition: 0.3s;
        }
        .maint-switch:hover { border-color: var(--dim); }
        .maint-switch.active { border-color: var(--alert); background: rgba(255, 42, 109, 0.05); }
        
        .switch-label { font-weight: bold; font-size: 14px; }
        .switch-status { font-size: 10px; padding: 4px 8px; border: 1px solid var(--dim); color: var(--dim); }
        .maint-switch.active .switch-status { border-color: var(--alert); color: var(--alert); background: rgba(0,0,0,0.5); }

        /* --- Auth Input Special --- */
        .auth-field { border-color: var(--alert); color: var(--alert); font-weight: bold; letter-spacing: 3px; text-align: center; }

        /* --- Bottom Actions --- */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 15px 20px; background: rgba(5,5,5,0.95); border-top: 1px solid var(--line);
            display: flex; gap: 10px; z-index: 90;
        }
        button { 
            flex: 1; padding: 15px; border: none; background: #222; color: var(--dim); 
            font-family: inherit; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        button.primary { background: var(--active); color: #000; }
        button:hover { opacity: 0.9; color: #fff; }
        button.primary:hover { color: #000; }

        /* --- Loader Overlay --- */
        #loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(5px); transition: opacity 0.3s;
        }
        .loader-text { color: var(--active); font-size: 12px; margin-top: 15px; letter-spacing: 2px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

    </style>
</head>
<body>

    <div id="loader">
        <div style="width: 50px; height: 50px; border: 2px solid var(--active); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <div class="loader-text" id="loaderMsg">CONNECTING...</div>
    </div>
    <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>

    <header>
        <h1>SYS.CORE <span>// MAINT</span></h1>
        <a href="../" class="back-link">← DASHBOARD</a>
    </header>

    <div class="container">

        <div class="card">
            <div class="card-title">System Status Control</div>
            
            <input type="checkbox" id="maintenance" style="display:none;" onchange="updateSwitchUI()">
            
            <div class="maint-switch" id="maintSwitchUI" onclick="document.getElementById('maintenance').click()">
                <div>
                    <div class="switch-label">MAINTENANCE MODE</div>
                    <div style="font-size: 10px; color: var(--dim); margin-top: 5px;">Lock user access to frontend</div>
                </div>
                <div class="switch-status" id="switchText">NORMAL OPS</div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Version Control</div>
            <div class="grid-row">
                <div class="input-group">
                    <label>VER. CODE</label>
                    <input type="text" id="versionCode" placeholder="1.0.0">
                </div>
                <div class="input-group">
                    <label>TYPE (HIPE)</label>
                    <input type="text" id="versionHipe" placeholder="RC / STABLE">
                </div>
                <div class="input-group">
                    <label>BUILD ID</label>
                    <input type="number" id="versionDate" placeholder="YYMMDD">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Downtime Schedule (Server Time)</div>
            <div class="grid-half">
                <div class="input-group">
                    <label>START TIME</label>
                    <input type="datetime-local" id="timeStart">
                </div>
                <div class="input-group">
                    <label>END TIME</label>
                    <input type="datetime-local" id="timeEnd">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Public Announcement</div>
            <div class="input-group">
                <label>MESSAGE (TRADITIONAL CHINESE)</label>
                <textarea id="purposeCH" placeholder="系統維護中..."></textarea>
            </div>
            <div class="input-group">
                <label>MESSAGE (ENGLISH)</label>
                <textarea id="purposeEG" placeholder="System under maintenance..."></textarea>
            </div>
        </div>

    </div>

    <div class="bottom-bar">
        <button onclick="fetchData()">DISCARD / RELOAD</button>
        <button class="primary" onclick="saveData()">EXECUTE & SAVE</button>
    </div>

    <script>
        const API_URL = '/api';

        const loader = document.getElementById('loader');
        const loaderMsg = document.getElementById('loaderMsg');

        window.onload = () => {
            fetchData();
        };

        function updateSwitchUI() {
            const chk = document.getElementById('maintenance');
            const ui = document.getElementById('maintSwitchUI');
            const txt = document.getElementById('switchText');

            if (chk.checked) {
                ui.classList.add('active');
                txt.innerText = 'SYSTEM LOCKED';
            } else {
                ui.classList.remove('active');
                txt.innerText = 'NORMAL OPS';
            }
        }

        function setStatus(state, msg) {
            loaderMsg.textContent = msg;
            if (state === 'busy') {
                loader.style.opacity = '1';
                loader.style.pointerEvents = 'auto';
            } else if (state === 'ready') {
                loader.style.opacity = '0';
                loader.style.pointerEvents = 'none';
            } else if (state === 'error') {
                loader.style.opacity = '1';
                alert('ERROR: ' + msg);
                setTimeout(() => {
                    loader.style.opacity = '0';
                    loader.style.pointerEvents = 'none';
                }, 2000);
            }
        }

        function formatToInput(dateStr) {
            return dateStr ? String(dateStr).replace(/\//g, '-').replace(' ', 'T') : '';
        }

        function formatToJson(dateStr) {
            return dateStr ? String(dateStr).replace(/-/g, '/').replace('T', ' ') : '';
        }

        function fetchData() {
            setStatus('busy', 'SYNCING CONFIG...');
            fetch(API_URL)
                .then(res => res.json())
                .then(json => {
                    if (json.status === 'success') {
                        const data = (json.data && json.data.maintenance) ? json.data.maintenance : (json.data || {});
                        document.getElementById('maintenance').checked = !!data.maintenance;
                        updateSwitchUI();

                        document.getElementById('versionCode').value = data.versionCode || '';
                        document.getElementById('versionHipe').value = data.versionHipe || '';
                        document.getElementById('versionDate').value = data.versionDate || '';
                        document.getElementById('timeStart').value = formatToInput(data.timeStart || '');
                        document.getElementById('timeEnd').value = formatToInput(data.timeEnd || '');
                        document.getElementById('purposeCH').value = data.purposeCH || '';
                        document.getElementById('purposeEG').value = data.purposeEG || '';

                        setStatus('ready', '');
                    } else {
                        setStatus('error', json.error || json.message || 'FETCH_FAILED');
                    }
                })
                .catch(err => setStatus('error', err));
        }

        function saveData() {
            const inputCH = document.getElementById('purposeCH');
            const inputEG = document.getElementById('purposeEG');

            if (!inputCH.value.trim()) inputCH.value = '維護完成，請重新連線。';
            if (!inputEG.value.trim()) inputEG.value = 'Maintenance complete. Please reconnect.';

            setStatus('busy', 'UPLOADING...');

            const payload = {
                action: 'update_maintenance',
                data: {
                    maintenance: document.getElementById('maintenance').checked,
                    versionCode: document.getElementById('versionCode').value,
                    versionHipe: document.getElementById('versionHipe').value,
                    versionDate: document.getElementById('versionDate').value,
                    timeStart: formatToJson(document.getElementById('timeStart').value),
                    timeEnd: formatToJson(document.getElementById('timeEnd').value),
                    purposeCH: inputCH.value,
                    purposeEG: inputEG.value
                }
            };

            fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(res => res.json().then(j => ({ ok: res.ok, j })))
                .then(({ ok, j }) => {
                    if (ok && j.status === 'success') {
                        setStatus('ready', '');
                        alert('CONFIGURATION UPDATED.');
                    } else {
                        setStatus('error', j.error || j.message || 'SAVE_FAILED');
                    }
                })
                .catch(err => setStatus('error', err));
        }
    </script>
</body>
</html>