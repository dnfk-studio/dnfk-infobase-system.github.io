<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDA.INGEST // REPORT</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --panel: #111; --line: #333; --active: #00f0ff; --alert: #ff2a6d; --text: #ddd; --dim: #666; }
        * { box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', monospace; margin: 0; display: flex; flex-direction: column; min-height: 100vh; }

        header { height: 60px; border-bottom: 1px solid var(--line); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; background: rgba(5,5,5,0.9); }
        h1 { font-size: 16px; margin: 0; color: var(--active); letter-spacing: 2px; }
        .back-link { color: var(--dim); text-decoration: none; font-size: 12px; }

        .container { max-width: 780px; margin: 40px auto; padding: 20px; }

        .toolbar { display:flex; gap:10px; align-items:center; margin-bottom:12px; }
        .toolbar input, .toolbar select { background:#000; border:1px solid var(--line); color:#fff; padding:10px; font-family:inherit; font-size:12px; }

        .card { background: rgba(255,255,255,0.03); border: 1px solid var(--line); padding: 25px; margin-bottom: 20px; }
        .card-header { font-size: 12px; color: var(--active); margin-bottom: 15px; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 10px; }

        .input-group { margin-bottom: 20px; }
        label { display: block; font-size: 10px; color: var(--dim); margin-bottom: 8px; }
        select, input, textarea { width: 100%; background: #000; border: 1px solid var(--line); color: #fff; padding: 12px; font-family: inherit; font-size: 14px; }
        select:focus, input:focus, textarea:focus { border-color: var(--active); outline: none; }
        textarea { height: 120px; resize: vertical; }

        .range-container { display: flex; align-items: center; gap: 15px; }
        input[type="range"] { flex: 1; accent-color: var(--active); height: 2px; background: var(--line); border: none; }
        .progress-val { font-size: 20px; font-weight: bold; color: var(--active); width: 60px; text-align: right; }

        .file-drop { border: 2px dashed var(--line); padding: 22px; text-align: center; cursor: pointer; transition: 0.2s; color: var(--dim); font-size: 12px; }
        .file-drop:hover { border-color: var(--active); color: var(--text); background: rgba(0,240,255,0.05); }
        .file-list { margin-top: 10px; font-size: 12px; color: var(--dim); }
        .file-item { display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px solid #222; }
        .file-item span { color: var(--text); }
        .file-item button { background:none; border:1px solid var(--line); color: var(--dim); font-family:inherit; padding:4px 8px; cursor:pointer; }
        .file-item button:hover { border-color:#fff; color:#fff; }

        button.submit { width: 100%; background: var(--active); color: #000; border: none; padding: 15px; font-family: inherit; font-weight: bold; font-size: 14px; cursor: pointer; margin-top: 10px; text-transform: uppercase; letter-spacing: 1px; }
        button.submit:hover { opacity: 0.9; }

        .read-only-field { opacity: 0.6; pointer-events: none; background: #111; }

        .data-table { width:100%; border-collapse:collapse; font-size:12px; }
        .data-table th { text-align:left; border-bottom:1px solid var(--active); padding:10px; color:var(--active); position:sticky; top:0; background: var(--bg); }
        .data-table td { border-bottom:1px solid #222; padding:10px; color:var(--text); vertical-align:top; }
        .tag { padding:2px 6px; background:#222; border:1px solid var(--dim); border-radius:4px; font-size:10px; }
        .tag.ok { border-color: var(--active); color: var(--active); }
        .tag.bad { border-color: var(--alert); color: var(--alert); }

        .hint { font-size: 11px; color: var(--dim); line-height: 1.6; }
        a.link { color: var(--active); text-decoration:none; }
        a.link:hover { text-decoration:underline; }
    </style>
</head>
<body>
    <header>
        <h1>CDA.INGEST</h1>
        <a href="../" class="back-link">← HUB</a>
    </header>

    <div class="container">

        <div class="card">
            <div class="card-header">Identity</div>
            <div class="input-group">
                <label>SELECT REPORTER EMAIL (TRUST MODE)</label>
                <select id="reporterSelect" onchange="applyReporterFilter()">
                    <option value="">-- SELECT --</option>
                    <option value="rkgrbg@gmail.com">rkgrbg@gmail.com</option>
                    <option value="dnfkyao@gmail.com">dnfkyao@gmail.com</option>
                    <option value="s1131314@stu.ccsh.tp.edu.tw">s1131314@stu.ccsh.tp.edu.tw</option>
                    <option value="wayne001283@gmail.com">wayne001283@gmail.com</option>
                </select>
            </div>
            <div class="hint">
                1) 你送出的回報會以你選擇的 email 身份記錄。<br>
                2) 下方「My Reports」預設會依你選擇的身份顯示。<br>
                3) 檔案上傳限制：單檔 ≤ 10MB，多檔可一起上傳。
            </div>
        </div>

        <div class="card">
            <div class="card-header">Target Task</div>
            <div class="input-group">
                <label>SELECT ASSIGNED TASK</label>
                <select id="taskSelect" onchange="updateTaskInfo()">
                    <option value="">-- Loading Tasks --</option>
                </select>
            </div>
            <div id="taskDetails" style="font-size: 12px; color: var(--dim); display:none; padding: 10px; background: rgba(0,0,0,0.3);">
                CURRENT PROGRESS: <span id="currentProg" style="color:var(--text)">0%</span> | OWNER: <span id="currentOwner" style="color:var(--text)">-</span> | DEADLINE: <span id="currentDeadline" style="color:var(--text)">-</span>
            </div>
        </div>

        <div class="card" id="reportForm" style="opacity:0.5; pointer-events:none;">
            <div class="card-header">Progress Report</div>

            <div class="input-group">
                <label>REPORT TIME</label>
                <input type="text" value="SERVER CLOUD TIME (AUTO)" class="read-only-field" readonly>
            </div>

            <div class="input-group">
                <label>OPTIONAL: PROOF LINK (GOOGLE DRIVE LINK)</label>
                <input type="text" id="proofLink" placeholder="Paste link...">
            </div>

            <div class="input-group">
                <label>UPLOAD FILE(S) TO DRIVE (≤ 10MB EACH)</label>
                <div class="file-drop" id="dropZone" onclick="document.getElementById('fileInput').click()">
                    CLICK OR DROP FILES HERE
                </div>
                <input type="file" id="fileInput" multiple style="display:none" onchange="handleFiles(this.files)">
                <div class="file-list" id="fileList"></div>
            </div>

            <div class="input-group">
                <label>EXECUTION DESCRIPTION</label>
                <textarea id="desc" placeholder="Describe work done..."></textarea>
            </div>

            <div class="input-group">
                <label>SELF-ASSESSED COMPLETION (%)</label>
                <div class="range-container">
                    <input type="range" min="0" max="100" value="0" id="progInput" oninput="document.getElementById('progVal').innerText = this.value + '%'">
                    <span id="progVal" class="progress-val">0%</span>
                </div>
            </div>

            <button class="submit" onclick="submitReport()">TRANSMIT REPORT</button>
        </div>

        <div class="card">
            <div class="card-header">My Reports</div>

            <div class="toolbar">
                <input id="repSearch" placeholder="Search reports..." oninput="renderReports()" style="flex:1">
                <select id="repStatus" onchange="renderReports()">
                    <option value="">STATUS: ALL</option>
                    <option value="pending">PENDING</option>
                    <option value="approved">APPROVED</option>
                    <option value="rejected">REJECTED</option>
                    <option value="deleted">DELETED</option>
                    <option value="error">ERROR</option>
                </select>
                <select id="repSort" onchange="renderReports()">
                    <option value="createdAt_desc">SORT: NEWEST</option>
                    <option value="createdAt_asc">SORT: OLDEST</option>
                </select>
            </div>

            <div style="max-height:380px; overflow:auto; border:1px solid #222;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>TIME</th>
                            <th>TASK</th>
                            <th>SELF</th>
                            <th>STATUS</th>
                            <th>NOTE</th>
                        </tr>
                    </thead>
                    <tbody id="reportBody"></tbody>
                </table>
            </div>

            <div class="hint" style="margin-top:10px;">
                備註：審核狀態由管理端更新（同意/駁回/刪除）。如果上傳失敗，狀態可能顯示為 ERROR。
            </div>
        </div>

    </div>

    <script>
        const API_URL = '/api';

        let tasks = [];
        let reports = [];
        let selectedFiles = []; // File[]

        window.onload = () => {
            setupDropZone();
            fetchBootstrap();
        };

        function setupDropZone(){
            const dz = document.getElementById('dropZone');
            dz.addEventListener('dragover', (e)=>{ e.preventDefault(); dz.style.borderColor = 'var(--active)'; });
            dz.addEventListener('dragleave', ()=>{ dz.style.borderColor = 'var(--line)'; });
            dz.addEventListener('drop', (e)=>{
                e.preventDefault();
                dz.style.borderColor = 'var(--line)';
                if(e.dataTransfer && e.dataTransfer.files) handleFiles(e.dataTransfer.files);
            });
        }

        async function fetchBootstrap(){
            try{
                const r = await fetch(API_URL);
                const json = await r.json();
                tasks = (json?.data?.cdaProject?.tasks) || [];
                reports = (json?.data?.cdaReport?.reports) || [];
                renderTaskSelect();
                applyReporterFilter();
            }catch(e){
                alert('ERROR LOADING DATA: ' + e);
            }
        }

        function renderTaskSelect(){
            const sel = document.getElementById('taskSelect');
            sel.innerHTML = '<option value="">-- SELECT TASK --</option>';
            tasks.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.innerText = `[${t.category}] ${t.title} (Current: ${t.percent}%)`;
                sel.appendChild(opt);
            });
        }

        function updateTaskInfo() {
            const id = document.getElementById('taskSelect').value;
            const form = document.getElementById('reportForm');

            if(id) {
                const t = tasks.find(x => x.id === id);
                document.getElementById('taskDetails').style.display = 'block';
                document.getElementById('currentProg').innerText = (t?.percent ?? 0) + '%';
                document.getElementById('currentOwner').innerText = t?.owner ?? '-';
                document.getElementById('currentDeadline').innerText = t?.deadline ?? '-';

                // Set default slider to current progress
                document.getElementById('progInput').value = (t?.percent ?? 0);
                document.getElementById('progVal').innerText = (t?.percent ?? 0) + '%';

                form.style.opacity = 1;
                form.style.pointerEvents = 'auto';
            } else {
                document.getElementById('taskDetails').style.display = 'none';
                form.style.opacity = 0.5;
                form.style.pointerEvents = 'none';
            }
        }

        function handleFiles(fileList){
            const arr = Array.from(fileList || []);
            for(const f of arr){
                if(f.size > 10 * 1024 * 1024){
                    alert(`FILE TOO LARGE (>10MB): ${f.name}`);
                    continue;
                }
                selectedFiles.push(f);
            }
            renderFileList();
        }

        function renderFileList(){
            const box = document.getElementById('fileList');
            if(selectedFiles.length === 0){
                box.innerHTML = '<div style="padding-top:6px;">NO FILE SELECTED</div>';
                return;
            }
            box.innerHTML = '';
            selectedFiles.forEach((f, idx)=>{
                const row = document.createElement('div');
                row.className = 'file-item';
                row.innerHTML = `<span>${f.name} (${Math.round(f.size/1024)} KB)</span><button onclick="removeFile(${idx})">REMOVE</button>`;
                box.appendChild(row);
            });
        }

        function removeFile(idx){
            selectedFiles.splice(idx, 1);
            renderFileList();
        }

        function applyReporterFilter(){
            renderReports();
        }

        function renderReports(){
            const reporter = document.getElementById('reporterSelect').value;
            const q = (document.getElementById('repSearch').value || '').toLowerCase();
            const status = document.getElementById('repStatus').value;
            const sortKey = document.getElementById('repSort').value;

            let list = reports.slice();

            if(reporter){
                list = list.filter(r => (r?.reporterEmail || '') === reporter);
            }
            if(status){
                list = list.filter(r => (r?.review?.status || r?.status || '') === status);
            }
            if(q){
                list = list.filter(r => {
                    const taskTitle = (r?.taskSnapshot?.title || '').toLowerCase();
                    const desc = (r?.description || '').toLowerCase();
                    const note = (r?.review?.note || '').toLowerCase();
                    const taskId = (r?.taskId || '').toLowerCase();
                    return taskTitle.includes(q) || desc.includes(q) || note.includes(q) || taskId.includes(q);
                });
            }

            list.sort((a,b)=>{
                const ta = new Date(a.createdAt || 0).getTime();
                const tb = new Date(b.createdAt || 0).getTime();
                return sortKey === 'createdAt_asc' ? (ta - tb) : (tb - ta);
            });

            const tbody = document.getElementById('reportBody');
            tbody.innerHTML = '';
            for(const r of list){
                const tr = document.createElement('tr');
                const st = (r?.review?.status || 'pending');
                const stTag = st === 'approved' ? '<span class="tag ok">APPROVED</span>' : (st === 'rejected' ? '<span class="tag bad">REJECTED</span>' : (st === 'deleted' ? '<span class="tag bad">DELETED</span>' : (st === 'error' ? '<span class="tag bad">ERROR</span>' : '<span class="tag">PENDING</span>')));

                const taskLabel = r?.taskSnapshot?.title ? `${r.taskId} / ${r.taskSnapshot.title}` : (r?.taskId || '-');
                const note = r?.review?.note || '';

                tr.innerHTML = `
                    <td>${(r.createdAt || '').replace('T',' ').replace('+08:00','')}</td>
                    <td>${escapeHtml(taskLabel)}</td>
                    <td>${Number(r.selfProgress ?? r.progress ?? 0)}%</td>
                    <td>${stTag}</td>
                    <td>${escapeHtml(note)}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        async function submitReport() {
            const reporterEmail = document.getElementById('reporterSelect').value;
            if(!reporterEmail){
                alert('PLEASE SELECT REPORTER EMAIL FIRST.');
                document.getElementById('reporterSelect').focus();
                return;
            }

            const taskId = document.getElementById('taskSelect').value;
            if(!taskId) return;

            const btn = document.querySelector('button.submit');
            btn.innerText = 'UPLOADING...';
            btn.disabled = true;

            try{
                const attachments = [];
                for(const f of selectedFiles){
                    const b64 = await fileToBase64(f);
                    attachments.push({
                        name: f.name,
                        mimeType: f.type || 'application/octet-stream',
                        dataBase64: b64
                    });
                }

                const payload = {
                    action: 'submit_report',
                    reporterEmail,
                    taskId,
                    proofLink: document.getElementById('proofLink').value,
                    description: document.getElementById('desc').value,
                    progress: Number(document.getElementById('progInput').value),
                    attachments
                };

                const res = await fetch(API_URL, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                if(json?.status !== 'success') throw new Error(json?.message || 'UNKNOWN');

                alert('REPORT LOGGED SUCCESSFULLY.');
                // refresh
                selectedFiles = [];
                renderFileList();
                await fetchBootstrap();
            }catch(e){
                alert('ERROR: ' + e);
            }finally{
                btn.innerText = 'TRANSMIT REPORT';
                btn.disabled = false;
            }
        }

        function fileToBase64(file){
            return new Promise((resolve, reject)=>{
                const reader = new FileReader();
                reader.onload = () => {
                    const result = String(reader.result || '');
                    const idx = result.indexOf('base64,');
                    resolve(idx >= 0 ? result.slice(idx + 7) : result);
                };
                reader.onerror = () => reject(reader.error || new Error('FILE_READ_ERROR'));
                reader.readAsDataURL(file);
            });
        }

        function escapeHtml(str){
            return String(str || '')
              .replaceAll('&','&amp;')
              .replaceAll('<','&lt;')
              .replaceAll('>','&gt;')
              .replaceAll('"','&quot;')
              .replaceAll("'",'&#039;');
        }

        // initial file list
        renderFileList();
    </script>
</body>
</html>
